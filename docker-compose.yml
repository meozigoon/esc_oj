services:
    postgres:
        image: postgres:15
        environment:
            POSTGRES_USER: oj
            POSTGRES_PASSWORD: ojpass
            POSTGRES_DB: oj
        ports:
            - "5432:5432"
        volumes:
            - postgres_data:/var/lib/postgresql/data
    redis:
        image: redis:7-alpine
        ports:
            - "6379:6379"
    server:
        build:
            context: .
            dockerfile: server/Dockerfile
        environment:
            DATABASE_URL: postgresql://oj:ojpass@postgres:5432/oj?schema=public
            REDIS_URL: redis://redis:6379
            JWT_SECRET: dev-secret-change
            CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:5173}
            PORT: 3000
            DATA_DIR: /app/data
        ports:
            - "3000:3000"
        depends_on:
            - postgres
            - redis
        volumes:
            - ./data:/app/data
    worker:
        build:
            context: .
            dockerfile: worker/Dockerfile
        environment:
            DATABASE_URL: postgresql://oj:ojpass@postgres:5432/oj?schema=public
            REDIS_URL: redis://redis:6379
            JUDGE_IMAGE: oj-runner:latest
            WORKER_CONCURRENCY: 4
            DATA_DIR: /app/data
        depends_on:
            - postgres
            - redis
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock
            - ./data:/app/data
volumes:
    postgres_data:
